angular.module("starter.services",[]).factory("WeatherInfo",["$rootScope","WeatherUtil","$ionicPlatform",function(e,t,n){var r=[],a=-1,i={towns:[],isLoadComplete:!1},o=function(e){var t={};void 0===e?(t.currentPosition=!0,t.address=null,t.location=null,t.currentWeather=null,t.timeTable=null,t.timeChart=null,t.dayTable=null,t.dayChart=null,t.disable=!0):(t.currentPosition=e.currentPosition,t.address=e.address,t.location=e.location,t.currentWeather=e.currentWeather,t.timeTable=e.timeTable,t.timeChart=e.timeChart,t.dayTable=e.dayTable,t.dayChart=e.dayChart,t.disable=void 0===e.disable?!1:e.disable),t.loadTime=null,r.push(t)};return i.getIndexOfCity=function(e){for(var t=0;t<r.length;t+=1)if(r[t].currentPosition===!0){if(e.currentPosition===!0)return t}else if(r[t].address===e.address)return t;return-1},i.getCityOfIndex=function(e){return 0>e||e>=r.length?null:r[e]},i.getCityCount=function(){return r.length},i.getEnabledCityCount=function(){for(var e=r.length,t=0;t<r.length;t+=1)r[t].disable===!0&&(e-=1);return e},i.getCityIndex=function(){return a},i.setCityIndex=function(e){e>=-1&&e<r.length&&(a=e,localStorage.setItem("cityIndex",JSON.stringify(a)))},i.setFirstCityIndex=function(){var e=this,t=r[0];e.setCityIndex(t.disable===!0?1===r.length?-1:1:0)},i.setPrevCityIndex=function(){var e=this,t=r[0];e.setCityIndex(0===a||1===a&&t.disable===!0?r.length-1:a-1)},i.setNextCityIndex=function(){var e=this;a===r.length-1?e.setFirstCityIndex():e.setCityIndex(a+1)},i.canLoadCity=function(e){var t=r[e];if(t.disable===!0)return!1;var n=new Date;return!!(null===t.loadTime||n.getTime()-t.loadTime.getTime()>6e5)},i.addCity=function(e){var t=this;return-1===t.getIndexOfCity(e)?(e.disable=!1,e.loadTime=null,r.push(e),t.saveCities(),!0):!1},i.removeCity=function(e){var t=this;return-1!==e?(r.splice(e,1),t.saveCities(),a===t.getCityCount()&&t.setFirstCityIndex(),!0):!1},i.disableCity=function(e){var t=this;r[0].disable=e,t.saveCities(),0>=a&&t.setFirstCityIndex()},i.reloadCity=function(e){var t=r[e];t.loadTime=null},i.updateCity=function(e,t){var n=this,a=r[e];t.address&&(a.address=t.address),t.location&&(a.location=t.location),t.currentWeather&&(a.currentWeather=t.currentWeather),t.timeTable&&(a.timeTable=t.timeTable),t.timeChart&&(a.timeChart=t.timeChart),t.dayTable&&(a.dayTable=t.dayTable),t.dayChart&&(a.dayChart=t.dayChart),window.push&&1==a.currentPosition&&window.push.getAlarm(e)&&window.push.updateAlarm(e,a.address),a.loadTime=new Date,n.saveCities()},i.loadCities=function(){var e=this,t=JSON.parse(localStorage.getItem("cities"));null===t?o():t.forEach(function(e){o(e)}),a=JSON.parse(localStorage.getItem("cityIndex")),null===a&&e.setFirstCityIndex()},i.saveCities=function(){localStorage.setItem("cities",JSON.stringify(r))},i.updateCities=function(a){var i=this,o=r[a];return void 0===o?void n.ready(function(){i.isLoadComplete=!0,e.$broadcast("loadCompleteEvent")}):void(i.canLoadCity(a)&&!o.currentPosition?t.getWeatherInfo(o.address,i.towns).then(function(e){var n=t.convertWeatherData(e);i.updateCity(a,n)}).finally(function(){i.updateCities(a+1)}):i.updateCities(a+1))},i.loadTowns=function(){var e=this;e.towns=window.towns},i}]).factory("WeatherUtil",["$q","$http","Util",function(e,t,n){function r(e,t,n,r){var a="";switch(a=r?"Moon":"Sun",e){case 1:a+="";break;case 2:a+="SmallCloud";break;case 3:a+="BigCloud";break;case 4:a="Cloud"}switch(t){case 0:a+="";break;case 1:a+="Rain";break;case 2:a+="RainSnow";break;case 3:a+="Snow"}return 1===n&&(a+="Lightning"),a}function a(e,t){if(0===e.length)return void 0;for(var n=0;n<e.length;n++)if(e[n].date===t)return e[n];return void 0}function i(e,t){if(!e||!t)return 0;var n=new Date(t.getFullYear(),t.getMonth(),t.getDate());return Math.ceil((e-n)/864e5)}function o(e){var t=e.substr(0,4),n=e.substr(4,2)-1,r=e.substr(6,2),a=new Date(t,n,r);return a.getFullYear()==t&&a.getMonth()==n&&a.getDate()==r?a:void 0}function s(e){var t=["엊그제","그제","어제","오늘","내일","모레","글피"];return e>=-3&&3>=e?t[e+3]:0>e?Math.abs(e)+"일 전":e>0?Math.abs(e)+"일 후":""}function u(e,t,n){if(void 0===t||null===t||void 0===n||null===n||n>t)return"Temp-01";var r=t-n,a=e-n,i=Math.max(1,Math.ceil(a/r*10));return i>9?"Temp-10":"Temp-0"+i}function d(e){switch(e){case 0:return"일";case 1:return"월";case 2:return"화";case 3:return"수";case 4:return"목";case 5:return"금";case 6:return"토"}return""}function c(e){switch(e){case"맑음":return"Sun";case"구름조금":return"SunSmallCloud";case"구름많음":return"SunBigCloud";case"흐림":return"Cloud";case"흐리고 한때 비":case"흐리고 비":return"CloudRain";case"구름적고 한때 비":case"구름적고 비":return"SunSmallCloudRain";case"구름많고 한때 비":case"구름많고 비":return"SunBigCloudRain";case"흐리고 한때 눈":case"흐리고 눈":return"CloudSnow";case"구름적고 한때 눈":case"구름적고 눈":return"SunSmallCloudSnow";case"구름많고 한때 눈":case"구름많고 눈":return"SunBigCloudSnow";case"구름적고 비/눈":case"구름적고 눈/비":return"SunSmallCloudRainSnow";case"구름많고 비/눈":case"구름많고 눈/비":return"SunBigCloudRainSnow";case"흐리고 비/눈":case"흐리고 눈/비":return"CloudRainSnow"}return""}function l(e,t){return-1!=e.indexOf("RainSnow")?e:-1!=t.indexOf("RainSnow")?t:-1!=e.indexOf("Rain")&&-1!=t.indexOf("Snow")?e+"Snow":-1!=e.indexOf("Snow")&&-1!=t.indexOf("Rain")?t+"Snow":e}function f(e){var t="Humidity-";return t+=100==e?"90":10*parseInt(e/10)}function h(e){var t="",n=0;return e.forEach(function(e){var r=e.formatted_address.slice(-1);("동"===r||"읍"===r||"면"===r)&&n<e.formatted_address.length&&(t=e.formatted_address,n=e.formatted_address.length)}),0===t.length,t}function m(e){var t={};return e.forEach(function(e){t.lat=e.geometry.location.lat,t.long=e.geometry.location.lng}),t}function g(r){var a=e.defer(),i=n.url+"/town";return i+="/"+r.first,r.second&&(i+="/"+r.second),r.third&&(i+="/"+r.third),t({method:"GET",url:i,timeout:1e4}).success(function(e){a.resolve({data:e})}).error(function(e){e||(e=new Error("Fail to get weatherInfo")),a.reject(e)}),a.promise}function v(n){var r=e.defer(),a="https://apis.daum.net/local/geo/addr2coord?apikey=6d0116e2c49361cb75eaf12f665e6360&q="+encodeURIComponent(n)+"&output=json";return t({method:"GET",url:a,timeout:3e3}).success(function(e){var t=e.channel.item[0].lat,n=e.channel.item[0].lng,a={lat:t,"long":n};r.resolve(a)}).error(function(e){r.reject(e)}),r.promise}function y(n){var r=e.defer(),a="https://maps.googleapis.com/maps/api/geocode/json?address="+n;return t({method:"GET",url:a,timeout:3e3}).success(function(e){if("OK"===e.status){var t=m(e.results);r.resolve(t)}else r.reject(new Error(e.status))}).error(function(e){r.reject(e)}),r.promise}function p(n,r){var a=e.defer(),i="https://apis.daum.net/local/geo/coord2addr?apikey=6d0116e2c49361cb75eaf12f665e6360&longitude="+r+"&latitude="+n+"&inputCoordSystem=WGS84&output=json";return t({method:"GET",url:i,timeout:3e3}).success(function(e){if(e.fullName){var t=e.fullName;t="대한민국 "+t,a.resolve(t)}else a.reject(new Error("Fail to get address name"))}).error(function(e){a.reject(e)}),a.promise}function C(n,r){var a=e.defer(),i="https://maps.googleapis.com/maps/api/geocode/json?latlng="+n+","+r+"&sensor=true&language=ko";return t({method:"GET",url:i,timeout:3e3}).success(function(e){if("OK"===e.status){var t=h(e.results);t&&0!==t.length||a.reject(new Error("Fail to find dong address from "+e.results[0].formatted_address)),a.resolve(t)}else a.reject(new Error(e.status))}).error(function(e){a.reject(e)}),a.promise}var w={};return w.parseCurrentTownWeather=function(e){var t,n,a={};return e?(t=parseInt(e.time.substr(0,2)),n=7>t||t>18,a=e,a.time=t,a.skyIcon=r(e.sky,e.pty,e.lgt,n),a):a},w.parseShortTownWeather=function(e,t,n,d){var c=[];if(!e||!Array.isArray(e))return{timeTable:[],timeChart:[]};e.every(function(t,l){var f,h=parseInt(t.time.slice(0,-2)),m=i(o(t.date),n),g="";(0===l||e[l-1].date!==t.date)&&(g=s(m));var v=7>h||h>18,y=a(d,t.date);return y||(y={date:t.date,taMax:100,taMin:-49}),f=t,f.skyIcon=r(t.sky,t.pty,t.lgt,v),f.tempIcon=u(t.t3h,y.taMax,y.taMin),f.day=g,f.time=h,f.timeStr=h+"시",c.push(f),!0});var l=c.slice(8),f=[{name:"yesterday",values:c.slice(0,c.length-8).map(function(e){return{name:"yesterday",value:e}})},{name:"today",values:c.slice(8).map(function(e){return{name:"today",value:e}})}];return{timeTable:l,timeChart:f}},w.parseMidTownWeather=function(e,t){var n=[];return e&&e.hasOwnProperty("dailyData")&&Array.isArray(e.dailyData)?(e.dailyData.forEach(function(e){var r;r=e;var a=i(o(r.date),t);r.fromToday=a,r.fromTodayStr=s(a),r.week=d(o(r.date).getDay());var u=c(e.wfAm),h=c(e.wfPm);r.skyIcon=l(u,h),r.tmx=e.taMax,r.tmn=e.taMin,r.humidityIcon=void 0!==r.reh?f(r.reh):"Humidity-00",n.push(r)}),n):n},w.convertTimeString=function(e){return e.getMonth()+1+"월 "+e.getDate()+"일("+d(e.getDay())+")  "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()},w.convertAddressArray=function(e){var t=[];return e&&e.split&&(t=e.split(" ")),t},w._getShortSiDoName=function(e){for(var t=["특별시","광역시","특별자치시","특별자치도"],n=0;n<t.length;n++)if(e.slice(-1*t[n].length)===t[n])return n===t.length-1?e.replace(t[n],"도"):e.replace(t[n],"시");return e},w.getShortenAddress=function(e){var t=this,n=t.convertAddressArray(e);return!n||n.length<2?"":5===n.length?t._getShortSiDoName(n[2])+","+n[4]:4===n.length?"도"===n[1].slice(-1)?t._getShortSiDoName(n[2])+","+n[3]:t._getShortSiDoName(n[1])+","+n[3]:3===n.length?t._getShortSiDoName(n[1])+","+n[2]:2===n.length?t._getShortSiDoName(n[1]):""},w.getTownFromFullAddress=function(e){var t={first:"",second:"",third:""};if(!Array.isArray(e)||0===e.length)return t;if(5===e.length)t.first=e[1],t.second=e[2]+e[3],t.third=e[4];else if(4===e.length)t.first=e[1],"구"===e[3].slice(-1)?t.second=e[2]+e[3]:(t.second=e[2],t.third=e[3]);else if(3===e.length)"읍"===e[2].slice(-1)||"면"===e[2].slice(-1)||"동"===e[2].slice(-1)?(t.first=e[1],t.second=e[1],t.third=e[2]):(t.first=e[1],t.second=e[2]);else if(2===e.length)t.first=e[1];else{new Error("Fail to parse address array="+e.toString())}return t},w.getAddressToGeolocation=function(t){var n=e.defer();return v(t).then(function(e){n.resolve(e)},function(e){y(t).then(function(e){n.resolve(e)},function(e){n.reject(e)})}),n.promise},w.getAddressFromGeolocation=function(t,n){var r=e.defer();return p(t,n).then(function(e){r.resolve(e)},function(e){C(t,n).then(function(e){r.resolve(e)},function(e){r.reject(e)})}),r.promise},w.getCurrentPosition=function(){var t=e.defer();if(ionic.Platform.isAndroid()&&window.cordova){var n=cordova.require("cordova/modulemapper").getOriginalSymbol(window,"navigator.geolocation");n.getCurrentPosition(function(e){t.resolve(e.coords)},function(e){t.reject()},{timeout:5e3})}else navigator.geolocation.getCurrentPosition(function(e){t.resolve(e.coords)},function(e){t.reject()},{timeout:3e3});return t.promise},w.getWeatherInfo=function(t,n){var r=this,a=r.convertAddressArray(t),i=r.getTownFromFullAddress(a),o=n.filter(function(e){return!(e.first!==i.first||e.second!==i.second||e.third!==i.third)})[0];if(void 0===o){var s=e.defer();return s.reject("address is empty"),s.promise}var u=[];return u.push(g(o)),e.all(u)},w.convertWeatherData=function(e){var t=this,n={},r=new Date,a={};e.forEach(function(e){e.hasOwnProperty("data")&&(a=e.data)});var i=t.parseCurrentTownWeather(a.current),o=t.parseShortTownWeather(a.short,i,r,a.midData.dailyData),s=t.parseMidTownWeather(a.midData,r);return n.currentWeather=i,n.timeTable=o.timeTable,n.timeChart=o.timeChart,n.dayTable=s,n.dayChart=[{values:s,temp:i.t1h}],n},w.getWeatherEmoji=function(e){return-1!=e.indexOf("Lightning")?"⛈":-1!=e.indexOf("RainSnow")?"☔☃":-1!=e.indexOf("Rain")?"☔":-1!=e.indexOf("Snow")?"☃":-1!=e.indexOf("Cloud")?-1!=e.indexOf("Sun")||-1!=e.indexOf("Moon")?"⛅":"☁":-1!=e.indexOf("Sun")||-1!=e.indexOf("Moon")?"🌞":""},w}]).factory("Util",["$window","$cordovaGoogleAnalytics",function(e,t){var n={},r=!1;return n.isDebug=function(){return r},n.ga={startTrackerWithId:function(n){return"undefined"!=typeof e.analytics?t.startTrackerWithId(n):void 0},setUserId:function(n){return"undefined"!=typeof e.analytics?t.setUserId(n):void 0},debugMode:function(){return"undefined"!=typeof e.analytics?t.debugMode():void 0},trackView:function(n){return"undefined"!=typeof e.analytics?t.trackView(n):void 0},addCustomDimension:function(n,r){return"undefined"!=typeof e.analytics?t.addCustomDimension(n,r):void 0},trackEvent:function(n,r,a,i){return"undefined"!=typeof e.analytics?t.trackEvent(n,r,a,i):void 0},trackException:function(n,r){return"undefined"!=typeof e.analytics?t.trackException(n,r):void 0},trackTiming:function(n,r,a,i){return"undefined"!=typeof e.analytics?t.trackTiming(n,r,a,i):void 0},addTransaction:function(n,r,a,i,o,s){return"undefined"!=typeof e.analytics?t.addTransaction(n,r,a,i,o,s):void 0},addTransactionItem:function(n,r,a,i,o,s,u){return"undefined"!=typeof e.analytics?t.addTransactionItem(n,r,a,i,o,s,u):void 0}},n.imgPath="img/weatherIcon",n.version="0.8.3",n.guideVersion=1,n.admobIOSBannerAdUnit="ca-app-pub-3300619349648096/7636193363",n.admobIOSInterstitialAdUnit="ca-app-pub-3300619349648096/3066392962",n.admobAndroidBannerAdUnit="ca-app-pub-3300619349648096/9569086167",n.admobAndroidInterstitialAdUnit="ca-app-pub-3300619349648096/2045819361",n.googleSenderId="362303467798",n.url=r?"http://tw-wzdfac.rhcloud.com/v000705":"http://todayweather.wizardfactory.net/v000705",n}]).run(["WeatherInfo",function(e){e.loadCities(),e.loadTowns(),e.updateCities(0)}]);