angular.module("starter.controllers",[]).controller("ForecastCtrl",["$scope","$rootScope","$ionicPlatform","$ionicScrollDelegate","$ionicNavBarDelegate","$q","$http","$timeout","WeatherInfo","WeatherUtil","Util","$stateParams","$location","$ionicHistory","$sce","$ionicLoading",function(t,e,n,o,i,r,a,s,c,d,l,u,h,f,g,p){function m(){l.ga.trackEvent("page","tab","forecast"),f.clearHistory();var e=1,n=1;460!==window.innerHeight&&480!==window.innerHeight||320!==window.innerWidth||(e=1.125,n=1.1),548!==window.innerHeight&&568!==window.innerHeight||320!==window.innerWidth||(n=1.1);var o=window.innerHeight-100;return P=.0408*o*e,P=33.04>P?P:33.04,k=.0376*o*e,k=30.45>k?k:30.45,E=.17544*o*e,E=142.1>E?E:142.1,B=.03384*o*e,B=27.4>B?B:27.4,H=.11264*o*e,H=91.2>H?H:91.2,O=.0299*o*n,O=19.37>O?O:19.37,D=.0512*o*n,D=33.17>D?D:33.17,L=.032*o*n,L=20.73>L?L:20.73,void 0!==u.fav&&u.fav<c.getCityCount()&&c.setCityIndex(u.fav),0===c.getEnabledCityCount()?void t.showAlert("에러","도시를 추가해주세요"):(p.show(),b(),void x())}function y(){var e="";return ionic.Platform.isIOS()&&(e+='<div style="height: 20px"></div>'),e+='<p class="textFont" style="font-size:'+P+'px; margin: 0">',$.currentPosition&&(e+='<a class="icon ion-ios-location-outline" style="color: white;"></a>'),e+=A+"</p>",e+='<div class="row row-no-padding"> <div style="margin: auto"> <div class="row row-no-padding">',e+='<p style="font-size: '+E+'px; margin: 0">'+$.currentWeather.t1h+"</p>",e+='<div style="text-align: left; margin: auto">',e+='<img style="height: '+B+'px" src="img/reddot.png">',e+="<br>",e+='<img style="height: '+H+'px" src="'+l.imgPath+"/"+$.currentWeather.skyIcon+'.png">',e+="</div>",e+="</div></div></div>",e+='<p class="textFont" style="font-size: '+k+'px; margin: 0;">'+t.currentWeather.summary+"</p>"}function v(){var e,n,o="";for(o+='<div class="row row-no-padding"> <div style="width: '+I/2+'px;"></div>',e=0;e<$.dayTable.length;e++)n=$.dayTable[e],n.date>$.timeTable[0].date&&n.date<=$.timeTable[$.timeTable.length-1].date&&(o+='<div class="col">',o+='<p style="font-size: '+O+'px; margin: 0; opacity: 0.84">',o+=t.getDayText(n),o+=' <span style="font-size: 13px; opacity: 0.54">',o+=t.getDayForecast(n),o+="</span></p></div>");for(o+='<div style="width: '+I/2+'px;"></div> </div>',o+='<hr style="margin: 0; border: 0; border-top:1px solid rgba(255,255,255,0.6);">',o+='<div class="row row-no-padding" style="flex: 1; text-align: center">',e=0;e<$.timeTable.length;e++)n=$.timeTable[e],o+='<div class="col table-items">',o+='<p style="font-size: '+O+'px; margin:auto">'+n.timeStr+"</p>",o+="<img width="+D+'px style="margin: auto" src="img/'+n.tempIcon+'.png">',o+='<p style="font-size: '+L+'px; margin: auto">'+n.t3h+"˚</p>",o+="<img width="+D+'px style="margin: auto" src="'+l.imgPath+"/"+n.skyIcon+'.png">',void 0!=n.rn1&&(n.date<$.currentWeather.date||n.time<=$.currentWeather.time)?(o+='<p style="font-size: '+L+'px; margin: auto">'+n.rn1,o+='<span style="font-size:10px">',o+=3===n.pty?"cm":"mm",o+="</span></p>"):o+='<p style="font-size: '+L+'px; margin: auto">'+n.pop+"<small>%</small></p>",o+="</div>";return o+="</div>"}function w(){var t,e,n="",o="-";for(n+='<hr style="margin: 0; border: 0; border-top:1px solid rgba(255,255,255,0.6);">',n+='<div class="row row-no-padding" style="flex: 1; text-align: center">',t=0;t<$.dayTable.length;t++)e=$.dayTable[t],n+='<div class="col table-items">',n+='<p style="margin: auto; font-size: '+O+"px;",0===e.fromToday?(n+=" border-bottom: 1px solid rgba(255,255,255,0.8);",n+=' opacity: 1;">'):n+=' opacity: 0.84;">',n+=e.week+"</p>",n+='<img style="width: '+D+'px; margin: auto;" src="'+l.imgPath+"/"+e.skyIcon+'.png">',void 0!=e.rn1?(n+='<p style="font-size: '+L+'px; margin: auto">'+e.rn1,n+='<span style="font-size:10px">',n+=3===e.pty?"cm":"mm",n+="</span></p>"):(o=void 0==e.pop?"-":e.pop+"<small>%</small>",n+='<p style="font-size: '+L+'px; margin: auto">'+o+"</p>"),n+='<img style="width: '+D+'px; margin: auto" src="img/'+e.humidityIcon+'.png">',o=void 0==e.reh?"-":e.reh+"<small>%</small>",n+='<p style="font-size: '+L+'px; margin: auto">'+o+"</p>",n+="</div>";return n+="</div>"}function b(){$=c.getCityOfIndex(c.getCityIndex()),null!==$&&null!==$.address&&(t.timeWidth=T()*$.timeTable.length,t.dayWidth=T()*$.dayTable.length,A=d.getShortenAddress($.address),t.currentWeather=$.currentWeather,t.timeChart=$.timeChart,t.dayChart=$.dayChart,t.currentPosition=$.currentPosition,setTimeout(function(){t.topMainBox=g.trustAsHtml(y()),t.shortTable=g.trustAsHtml(v()),t.midTable=g.trustAsHtml(w()),"short"===t.forecastType?o.$getByHandle("timeChart").scrollTo(S(),0,!1):"mid"===t.forecastType&&o.$getByHandle("weeklyChart").scrollTo(S(),0,!1)},100))}function x(){if(c.isLoadComplete!==!1){if(null===$.address||c.canLoadCity(c.getCityIndex())===!0)return p.show(),void C().finally(function(){A=d.getShortenAddress($.address),p.hide(),l.ga.trackEvent("weather","load",A,c.getCityIndex())});p.hide(),l.ga.trackEvent("weather","load",A,c.getCityIndex())}}function C(){var e=r.defer();return $.currentPosition===!0?d.getCurrentPosition().then(function(n){d.getAddressFromGeolocation(n.latitude,n.longitude).then(function(o){d.getWeatherInfo(o,c.towns).then(function(t){var i=d.convertWeatherData(t);i.address=o,i.location={lat:n.latitude,"long":n.longitude},c.updateCity(c.getCityIndex(),i),b(),e.resolve()},function(){var n="현재 위치 정보 업데이트를 실패하였습니다.";t.showAlert("에러",n),e.reject()})},function(){var n="현재 위치에 대한 정보를 찾을 수 없습니다.";t.showAlert("에러",n),e.reject()})},function(){var n="현재 위치를 찾을 수 없습니다.";ionic.Platform.isAndroid()&&(n+="<br>WIFI와 위치정보를 켜주세요."),t.showAlert("에러",n),e.reject()}):d.getWeatherInfo($.address,c.towns).then(function(t){var n=d.convertWeatherData(t);c.updateCity(c.getCityIndex(),n),b(),e.resolve()},function(){var n="위치 정보 업데이트를 실패하였습니다.";t.showAlert("에러",n),e.reject()}),e.promise}function T(){return I?I:(I=W/7,I>60&&(I=60),I)}function S(){var e=new Date,n=0;if("short"===t.forecastType){var o=e.getHours();return n=7,W>=720?T()*n:(o>=3&&(n+=1),o>=6&&(n+=1),o>=9&&(n+=1),T()*n)}if("mid"===t.forecastType){if(W>=720)return 0;var i=e.getDay(),r=1;return 1===i?n=5:(0===i&&(i=7,r+=1),n=6+r-i),T()*n}return T()*n}var I,W=window.innerWidth,$=null;t.forecastType="short";var A="";t.currentWeather,t.timeChart,t.dayChart,t.timeWidth,t.dayWidth;var P,k,E,B,H,O,D,L;t.changeForecastType=function(){"short"===t.forecastType?(t.forecastType="mid",e.viewColor="#8BC34A",window.StatusBar&&StatusBar.backgroundColorByHexString("#689F38"),setTimeout(function(){o.$getByHandle("weeklyChart").scrollTo(S(),0,!1)},0)):"mid"===t.forecastType?(t.forecastType="detail",e.viewColor="#00BCD4",window.StatusBar&&StatusBar.backgroundColorByHexString("#0097A7")):"detail"===t.forecastType&&(t.forecastType="short",e.viewColor="#03A9F4",window.StatusBar&&StatusBar.backgroundColorByHexString("#0288D1"),setTimeout(function(){o.$getByHandle("timeChart").scrollTo(S(),0,!1)},0))},t.onSwipeLeft=function(){1!==c.getEnabledCityCount()&&(c.setNextCityIndex(),b(),x())},t.onSwipeRight=function(){1!==c.getEnabledCityCount()&&(c.setPrevCityIndex(),b(),x())},t.getDayText=function(t){return t.fromTodayStr+" "+t.date.substr(4,2)+"."+t.date.substr(6,2)},t.getDayForecast=function(t){var e=[];return 0===t.fromToday||1===t.fromToday?(t.dustForecast&&t.dustForecast.PM10Str&&e.push("미세예보:"+t.dustForecast.PM10Str),t.ultrvStr&&e.push("자외선:"+t.ultrvStr),e.toString()):e.toString()},t.$on("loadCompleteEvent",function(){x()}),t.$on("reloadEvent",function(){c.reloadCity(c.getCityIndex()),x()}),m()}]).controller("SearchCtrl",["$scope","$rootScope","$ionicPlatform","$ionicScrollDelegate","$location","WeatherInfo","WeatherUtil","Util","ionicTimePicker","Push","$ionicLoading",function(t,e,n,o,i,r,a,s,c,d,l){function u(){s.ga.trackEvent("page","tab","search");for(var e=0;e<r.getCityCount();e+=1){var n=r.getCityOfIndex(e),o=a.getShortenAddress(n.address).split(","),i=null;n.currentPosition&&null===n.address&&(o=["현재","위치"]),n.currentWeather||(n.currentWeather={}),n.currentWeather.skyIcon||(n.currentWeather.skyIcon="Sun"),void 0===n.currentWeather.t1h&&(n.currentWeather.t1h="-"),null!=n.dayTable&&(i=n.dayTable.filter(function(t){return 0===t.fromToday})),i&&0!==i.length||(i=[{tmn:"-",tmx:"-"}]);var c={address:o,currentPosition:n.currentPosition,disable:n.disable,skyIcon:n.currentWeather.skyIcon,t1h:n.currentWeather.t1h,tmn:i[0].tmn,tmx:i[0].tmx,alarmInfo:d.getAlarm(e)};t.cityList.push(c)}}t.searchWord=void 0,t.searchResults=[],t.cityList=[],t.imgPath=s.imgPath,t.isEditing=!1;var h=r.towns,f=-1;t.OnChangeSearchWord=function(){return t.isEditing=!1,""===t.searchWord?(t.searchWord=void 0,void(t.searchResults=[])):(t.searchResults=[],o.$getByHandle("cityList").scrollTop(),f=0,void t.OnScrollResults())},t.OnSearchCurrentPosition=function(){t.isEditing=!1,l.show(),a.getCurrentPosition().then(function(e){a.getAddressFromGeolocation(e.latitude,e.longitude).then(function(e){var n=a.convertAddressArray(e),i=a.getTownFromFullAddress(n);if(""===i.first&&""===i.second&&""===i.third){var r="현재 위치에 대한 정보를 찾을 수 없습니다.";t.showAlert("에러",r)}else t.searchWord=""===i.third?""===i.second?i.first:i.second:i.third,t.searchResults=[],t.searchResults.push(i),o.$getByHandle("cityList").scrollTop(),f=-1;l.hide()},function(){var e="현재 위치에 대한 정보를 찾을 수 없습니다.";t.showAlert("에러",e),l.hide()})},function(){var e="현재 위치를 찾을 수 없습니다.";ionic.Platform.isAndroid()&&(e+="<br>WIFI와 위치정보를 켜주세요."),t.showAlert("에러",e),l.hide()})},t.OnEdit=function(){t.isEditing=!t.isEditing,t.isEditing&&(t.searchWord=void 0,t.searchResults=[])},t.OnScrollResults=function(){if(void 0!==t.searchWord&&-1!==f){for(var e=f;e<h.length;e++){var n=h[e];if((n.first.indexOf(t.searchWord)>=0||n.second.indexOf(t.searchWord)>=0||n.third.indexOf(t.searchWord)>=0)&&(t.searchResults.push(n),t.searchResults.length%10===0))return void(f=e+1)}f=-1}},t.OnSelectResult=function(e){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.isVisible)return cordova.plugins.Keyboard.close();t.searchWord=void 0,t.searchResults=[],l.show();var n="대한민국 "+e.first;if(""!==e.second)if("도"===e.first.slice(-1)&&"구"===e.second.slice(-1))if(e.second.indexOf(" ")>0){var o=e.second.split(" ");n=" "+o[0],n=" "+o[1]}else n+=" "+e.second.substr(0,e.second.indexOf("시")+1),n+=" "+e.second.substr(e.second.indexOf("시")+1,e.second.length);else n+=" "+e.second;""!==e.third&&(n+=" "+e.third),a.getWeatherInfo(n,r.towns).then(function(e){var o=a.convertWeatherData(e);if(o.currentPosition=!1,o.address=n,o.location=location,r.addCity(o)===!1){var s="이미 동일한 지역이 추가되어 있습니다.";t.showAlert("에러",s)}else r.setCityIndex(r.getCityCount()-1),i.path("/tab/forecast");l.hide()},function(){var e="현재 위치 정보 업데이트를 실패하였습니다.";t.showAlert("에러",e),l.hide()})},t.OnSelectCity=function(e){if(t.isEditing!==!0){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.isVisible)return cordova.plugins.Keyboard.close();r.setCityIndex(e),i.path("/tab/forecast")}},t.OnDisableCity=function(){return r.disableCity(t.cityList[0].disable),!1},t.OnDeleteCity=function(e){return void 0!=t.cityList[e].alarmInfo&&d.removeAlarm(t.cityList[e].alarmInfo),t.cityList.splice(e,1),r.removeCity(e),!1},t.OnOpenTimePicker=function(e){var n={callback:function(n){if("undefined"==typeof n);else if(0==n)void 0!=t.cityList[e].alarmInfo&&(d.removeAlarm(t.cityList[e].alarmInfo),t.cityList[e].alarmInfo=void 0);else{var o=new Date;o.setHours(0,0,0,0),o.setSeconds(n),d.updateAlarm(e,r.getCityOfIndex(e).address,o,function(n,o){t.cityList[e].alarmInfo=o})}}};if(void 0!=t.cityList[e].alarmInfo){var o=new Date(t.cityList[e].alarmInfo.time);n.inputTime=60*o.getHours()*60+60*o.getMinutes()}else n.inputTime=28800;c.openTimePicker(n)},u()}]).controller("SettingCtrl",["$scope","$http","$cordovaInAppBrowser","Util",function(t,e,n,o){function i(){o.ga.trackEvent("page","tab","setting"),window.chrome&&chrome.extension&&e({method:"GET",url:chrome.extension.getURL("manifest.json"),timeout:3e3}).success(function(e){t.version=e.version}).error(function(t){})}t.version=o.version,t.openMarket=function(){var t="";t=ionic.Platform.isIOS()?"https://itunes.apple.com/us/app/todayweather/id1041700694":ionic.Platform.isAndroid()?"https://play.google.com/store/apps/details?id=net.wizardfactory.todayweather":"https://www.facebook.com/TodayWeather.WF";var e={location:"yes",clearcache:"yes",toolbar:"no"};n.open(t,"_blank",e).then(function(t){}).catch(function(t){})},t.openInfo=function(){var e="기상정보 : 기상청 <br> 대기오염정보 : 환경부/한국환경공단 <br> 인증되지 않은 실시간 자료이므로 자료 오류가 있을 수 있습니다.";t.showAlert("TodayWeather",e)},i()}]).controller("TabCtrl",["$scope","$ionicPlatform","$ionicPopup","$interval","WeatherInfo","WeatherUtil","$location","$cordovaSocialSharing","TwAds","$rootScope","Util",function(t,e,n,o,i,r,a,s,c,d,l){function u(){h=new Date,t.currentTimeString=r.convertTimeString(h),o(function(){var e=new Date;e.getMinutes()!=h.getMinutes()&&(h=e,t.currentTimeString=r.convertTimeString(h))},1e3)}var h;t.doTabForecast=function(){return 0===i.getEnabledCityCount()?void t.showAlert("에러","도시를 추가해주세요"):void("/tab/forecast"===a.path()?(t.$broadcast("reloadEvent"),l.ga.trackEvent("page","tab","reload")):a.path("/tab/forecast"))},t.doTabShare=function(){var t="";if("/tab/forecast"===a.path()){var e=i.getCityOfIndex(i.getCityIndex());null!==e&&null!==e.location&&(t+=r.getShortenAddress(e.address)+"\n",t+="현재 "+e.currentWeather.t1h+"˚ ",t+=r.getWeatherEmoji(e.currentWeather.skyIcon)+"\n",e.dayTable.forEach(function(e){0===e.fromToday&&(t+="최고 "+e.tmx+"˚, 최저 "+e.tmn+"˚\n")}),t+=e.currentWeather.summary+"\n\n")}s.share(t+"오늘날씨 다운로드 >\nhttp://onelink.to/dqud4w",null,null,null).then(function(){},function(){}),l.ga.trackEvent("page","tab","share")},t.showAlert=function(t,e){var o=n.alert({title:t,template:e});o.then(function(){})},t.showConfirm=function(t,e,o){var i=n.confirm({title:t,template:e});i.then(function(t){o(t)})},e.ready(function(){d.viewAdsBanner=c.enableAds,d.contentBottom=c.enableAds?100:50,angular.element(document.getElementsByClassName("tabs")).css("margin-bottom",c.showAds?"50px":"0px")}),u()}]).controller("GuideCtrl",["$scope","$rootScope","$ionicSlideBoxDelegate","$ionicNavBarDelegate","$location","$ionicHistory","Util","TwAds","$ionicPopup","WeatherInfo",function(t,e,n,o,i,r,a,s,c,d){function l(){s.setShowAds(!1),a.ga.trackEvent("page","tab","guide"),t.bigFont=.0512*(window.innerHeight-56),t.smallFont=.0299*(window.innerHeight-56),g=localStorage.getItem("guideVersion"),h()}function u(){null===g?f():a.guideVersion==Number(g)?(s.setShowAds(!0),i.path("/tab/setting")):(localStorage.setItem("guideVersion",a.guideVersion.toString()),s.setShowAds(!0),i.path("/tab/forecast"))}function h(){n.currentIndex()==n.slidesCount()-1?(t.leftText="<",t.rightText="CLOSE"):(t.leftText="SKIP",t.rightText=">")}function f(){var e=c.show({template:'<ion-list><ion-radio ng-model="data.autoSearch" ng-value="true">현 위치 자동 검색</ion-radio><ion-radio ng-model="data.autoSearch" ng-value="false">직접 도시 검색</ion-radio></ion-list>',title:"도시 검색 방법을 선택하세요.",scope:t,cssClass:"ionic_popup",buttons:[{text:"취소",type:"button_cancel"},{text:"확인",type:"button_close",onTap:function(){return t.data.autoSearch}}]});e.then(function(t){void 0!==t&&(localStorage.setItem("guideVersion",a.guideVersion.toString()),s.setShowAds(!0),t===!0?(d.disableCity(!1),i.path("/tab/forecast")):i.path("/tab/search"))})}var g=null;t.data={autoSearch:!1},t.onSlideChanged=function(){h()},t.onLeftClick=function(){n.currentIndex()==n.slidesCount()-1?n.previous():u()},t.onRightClick=function(){n.currentIndex()==n.slidesCount()-1?u():n.next()},t.$on("$ionicView.leave",function(){s.setShowAds(!0)}),t.$on("$ionicView.enter",function(){s.setShowAds(!1),n.slide(0)}),l()}]);